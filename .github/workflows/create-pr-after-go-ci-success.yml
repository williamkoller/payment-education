name: Create PR After Go CI Success

on:
  workflow_run:
    workflows: ['Go CI & Codecov']
    types:
      - completed

permissions:
  contents: write
  pull-requests: write

jobs:
  ensure_pull_request:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest

    steps:
      - name: Ensure PR exists for successful workflow run
        uses: actions/github-script@v7
        with:
          github-token: ${{ github.token }}
          script: |
            const runId = context.payload.workflow_run.id;
            const { owner, repo } = context.repo;

            const { data: run } = await github.rest.actions.getWorkflowRun({
              owner,
              repo,
              run_id: runId,
            });

            const headRepoFullName = run.head_repository?.full_name;

            if (!headRepoFullName || headRepoFullName !== `${owner}/${repo}`) {
              core.notice('Workflow executado a partir de um fork. Ignorando.');
              return;
            }

            const headBranch = run.head_branch;

            if (!headBranch) {
              core.notice('Nenhum branch associado ao workflow. Nada a fazer.');
              return;
            }

            if (headBranch === 'main') {
              core.notice("Pulando criação de PR para o branch 'main'.");
              return;
            }

            const { data: existing } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${headBranch}`,
            });

            if (existing.length > 0) {
              core.notice(`PR #${existing[0].number} já existe para o branch ${headBranch}.`);
              return;
            }

            const title = `Automated PR from ${headBranch}`;
            const body = 'Esta PR foi criada automaticamente após o sucesso dos testes no workflow **Go CI & Codecov**.';

            const { data: pr } = await github.rest.pulls.create({
              owner,
              repo,
              head: headBranch,
              base: 'main',
              title,
              body,
              draft: false,
            });

            core.notice(`PR #${pr.number} criada automaticamente para o branch ${headBranch}.`);

